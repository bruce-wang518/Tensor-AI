# TensorAI 聊天系统启动/停止脚本 v2.0

## 概述

本项目包含两个增强版的脚本，用于管理 TensorAI 聊天系统的前端和代理服务器：

- `start-all.sh` - 一键启动脚本（增强调试版）
- `stop-all.sh` - 一键停止脚本（增强调试版）

## 新增功能

### 🎨 彩色日志输出
- **蓝色** - 信息日志 [INFO]
- **绿色** - 成功日志 [SUCCESS] 
- **黄色** - 警告日志 [WARNING]
- **红色** - 错误日志 [ERROR]

### 📝 详细调试信息
- 带时间戳的日志记录
- 系统环境检查
- 端口占用检查
- 进程状态监控
- 依赖检查和自动安装

### 🔍 智能进程管理
- 优雅停止进程（SIGTERM）
- 强制停止备用方案（SIGKILL）
- 多重进程查找策略
- 端口占用进程清理

### 📊 日志文件记录
- `logs/last_start.txt` - 最后启动时间
- `logs/last_stop.txt` - 最后停止时间
- `logs/stop_completed.txt` - 停止完成时间
- `logs/proxy.log` - 代理服务器日志

## 使用方法

### 启动服务
```bash
./start-all.sh
```

### 停止服务
```bash
./stop-all.sh
```

## 脚本功能详解

### start-all.sh 功能

1. **环境检查**
   - Node.js 和 npm 版本检查
   - 项目文件完整性检查
   - 端口占用状态检查
   - 现有进程检查

2. **依赖管理**
   - 自动检查项目依赖
   - 智能安装缺失的依赖包
   - 支持增量依赖安装

3. **日志管理**
   - 自动创建日志目录
   - 清理7天前的旧日志
   - 记录启动时间戳

4. **服务启动**
   - 使用 npm run dev 启动服务
   - 信号处理和优雅退出

### stop-all.sh 功能

1. **进程发现**
   - 多种方式查找相关进程
   - PID文件读取
   - 进程名称模式匹配
   - 端口占用进程查找

2. **安全停止**
   - 优雅停止（10秒超时）
   - 强制停止备用方案
   - 进程状态实时监控

3. **全面清理**
   - 代理服务器进程
   - React 前端进程
   - npm dev 进程
   - concurrently 进程
   - 端口占用进程

4. **最终验证**
   - 端口释放检查
   - 剩余进程检查
   - 临时文件清理

## 调试信息示例

### 启动脚本输出示例
```
=== TensorAI 聊天系统一键启动脚本 v2.0 ===
[2025-06-08 13:20:00] [INFO] 开始启动前端和代理服务器...
[2025-06-08 13:20:00] [INFO] 当前工作目录: /root/ragflow-chat
[2025-06-08 13:20:00] [INFO] 当前用户: root
[2025-06-08 13:20:00] [SUCCESS] Node.js 已安装: v18.17.0
[2025-06-08 13:20:00] [SUCCESS] npm 已安装: 9.6.7
[2025-06-08 13:20:00] [INFO] 端口 3000 可用
[2025-06-08 13:20:00] [INFO] 端口 3001 可用
```

### 停止脚本输出示例
```
=== TensorAI 聊天系统停止脚本 v2.0 ===
[2025-06-08 13:23:20] [INFO] 开始停止所有服务...
[2025-06-08 13:23:20] [INFO] 查找 代理服务器 进程...
[2025-06-08 13:23:20] [INFO] 正在停止 代理服务器 (PID: 12345)...
[2025-06-08 13:23:20] [SUCCESS] 代理服务器 已优雅停止
[2025-06-08 13:23:20] [SUCCESS] 端口 3000 已释放
[2025-06-08 13:23:20] [SUCCESS] 端口 3001 已释放
```

## 故障排除

### 常见问题

1. **端口被占用**
   - 脚本会自动检测并显示占用进程
   - 使用 stop-all.sh 清理占用进程

2. **依赖缺失**
   - 脚本会自动检测并安装缺失依赖
   - 如果安装失败，检查网络连接

3. **进程无法停止**
   - 脚本会尝试优雅停止和强制停止
   - 查看详细日志了解具体原因

### 手动清理命令

```bash
# 查看端口占用
lsof -i :3000
lsof -i :3001

# 手动停止进程
kill -TERM <PID>
kill -KILL <PID>

# 清理临时文件
rm -f .proxy.pid nohup.out
```

## 版本历史

### v2.0 (当前版本)
- 添加彩色日志输出
- 增强调试信息
- 智能进程管理
- 自动依赖检查
- 日志文件记录
- 安全停止机制

### v1.0 (原始版本)
- 基础启动/停止功能
- 简单的进程管理

## 技术细节

### 依赖要求
- Node.js (推荐 v16+)
- npm
- lsof (端口检查)
- ps (进程检查)

### 支持的服务
- React 前端应用 (端口 3000)
- CORS 代理服务器 (端口 3001)
- concurrently 进程管理器

### 日志级别
- INFO: 一般信息
- SUCCESS: 成功操作
- WARNING: 警告信息
- ERROR: 错误信息

---

**作者**: TensorAI  
**版本**: 2.0 (增强调试版)  
**更新时间**: 2025-06-08